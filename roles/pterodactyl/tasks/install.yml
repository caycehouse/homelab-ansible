- name: Download and unpack pterodactyl
  ansible.builtin.unarchive:
    src: https://github.com/pterodactyl/panel/releases/latest/download/panel.tar.gz
    dest: /var/www/pterodactyl
    remote_src: true

- name: Ensure storage and bootstrap/cache have the correct permissions
  ansible.builtin.file:
    path: "{{ item }}"
    mode: 0755
    recurse: true
  loop:
    - /var/www/pterodactyl/storage
    - /var/www/pterodactyl/bootstrap/cache

- name: Run composer and artisan commands
  block:
    - name: Run composer install
      community.general.composer:
        command: install
        working_dir: /var/www/pterodactyl
      environment:
        COMPOSER_ALLOW_SUPERUSER: 1

    - name: Run artisan migrate
      ansible.builtin.command: php artisan migrate --seed --force
      register: output
      changed_when: output.stdout != ''
      args:
        chdir: /var/www/pterodactyl

    - name: Create initial user
      ansible.builtin.command: >
        php artisan p:user:make
        --email={{ pterodactyl_panel_admin_mail }}
        --username={{ pterodactyl_panel_admin_user }}
        --password={{ pterodactyl_panel_admin_password }}
        --name-first={{ pterodactyl_panel_admin_firstname }}
        --name-last={{ pterodactyl_panel_admin_lastname }}
        --admin=1
      no_log: true
      register: output
      changed_when: output.rc == 0
      args:
        chdir: /var/www/pterodactyl

- name: Update owner/group for panel webroot
  ansible.builtin.file:
    path: /var/www/pterodactyl
    owner: www-data
    group: www-data
    recurse: true
